<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente con gesti√≥n de tareas</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #fafafa;
            color: #202020;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #fff;
            border-right: 1px solid #e1e1e1;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e1e1e1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 0 20px 8px;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .nav-item:hover {
            background: #f8f8f8;
        }

        .nav-item.active {
            background: #f3f3f3;
            border-right: 3px solid #db4035;
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            color: #666;
        }

        .nav-item-text {
            flex: 1;
            font-size: 14px;
        }

        .nav-item-count {
            background: #e1e1e1;
            color: #666;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
        }

        .project-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .project-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .nav-item:hover .project-actions {
            opacity: 1;
        }

        .project-action-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
        }

        .project-action-btn:hover {
            background: #e8e8e8;
            color: #333;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-header {
            background: #fff;
            padding: 20px 30px;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-title {
            font-size: 24px;
            font-weight: 700;
            color: #202020;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: #f8f8f8;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }

        .tasks-container {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
        }

        /* Task Form */
        .task-form {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .form-row input, .form-row select, .form-row textarea {
            padding: 10px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
        }

        .form-row input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .form-row textarea {
            flex: 1;
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        .form-row select {
            min-width: 140px;
        }

        .form-row input[type="datetime-local"] {
            min-width: 200px;
        }

        .add-btn {
            background: #34a853;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        /* Tasks */
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .task-item:hover {
            border-color: #d0d0d0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #e1e1e1;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-checkbox:hover {
            border-color: #db4035;
        }

        .task-checkbox.completed {
            background: #db4035;
            border-color: #db4035;
            color: white;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-size: 14px;
            font-weight: 500;
            color: #202020;
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .task-title.completed {
            text-decoration: line-through;
            color: #888;
        }

        .task-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .task-project {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-priority {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .priority-alta {
            background: #fce8e6;
            color: #d73a49;
        }

        .priority-media {
            background: #fff3cd;
            color: #856404;
        }

        .priority-baja {
            background: #d1ecf1;
            color: #0c5460;
        }

        .task-due-date {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .due-today {
            background: #fef2f2;
            color: #dc2626;
        }

        .due-overdue {
            background: #fef2f2;
            color: #dc2626;
            font-weight: 600;
        }

        .due-future {
            background: #f0f9ff;
            color: #0369a1;
        }

        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .task-label {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #f3f4f6;
            color: #4b5563;
        }

        .task-actions-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-item:hover .task-actions-menu {
            opacity: 1;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .subtasks {
            margin-left: 32px;
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }

        .subtask-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #e1e1e1;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .subtask-checkbox.completed {
            background: #db4035;
            border-color: #db4035;
            color: white;
        }

        .subtask-title {
            font-size: 13px;
            color: #374151;
        }

        .subtask-title.completed {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #202124;
        }

        .empty-description {
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: #f3f4f6;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #db4035;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #c23616;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f8f8f8;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e1e1e1;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        /* Etiquetas y subtareas en modal */
        .selected-labels {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .selected-label {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #f3f4f6;
            color: #374151;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }

        .remove-label-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            padding: 0;
            margin-left: 4px;
        }

        .remove-label-btn:hover {
            color: #ef4444;
        }

        .subtasks-editor {
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 12px;
            background: #f9f9f9;
        }

        .subtasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .subtask-editor-item {
            background: #fff;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
            padding: 8px;
        }

        .subtask-editor-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subtask-editor-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            padding: 4px;
            border-radius: 3px;
        }

        .subtask-editor-input:focus {
            outline: none;
            background: #f8f9fa;
        }

        .remove-subtask-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            border-radius: 3px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .remove-subtask-btn:hover {
            opacity: 1;
            background: #fef2f2;
        }

        /* AI Config Styles */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-item.full-width {
            grid-column: 1 / -1;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e1e1e1;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #db4035;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #db4035;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
        }

        .cost-indicator {
            background: #f0f9ff;
            border: 1px solid #0369a1;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .cost-indicator h4 {
            margin: 0 0 4px 0;
            color: #0369a1;
            font-size: 14px;
        }

        .cost-indicator .cost-value {
            font-size: 18px;
            font-weight: 600;
            color: #1e40af;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stats-card {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stats-card h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-card .stats-value {
            font-size: 24px;
            font-weight: 600;
            color: #202124;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .warning-box h4 {
            margin: 0 0 4px 0;
            color: #856404;
            font-size: 14px;
        }

        .warning-box p {
            margin: 0;
            color: #856404;
            font-size: 13px;
        }

        /* Chat del asistente */
        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 400px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: height 0.3s ease;
        }

        #chat-container.minimized {
            height: 50px;
        }

        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 14px;
            color: #202124;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-minimize-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            padding: 4px;
            border-radius: 4px;
        }

        .chat-minimize-btn:hover {
            background: #e8e8e8;
        }

        .chat-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            font-size: 14px;
        }

        #chat-container.minimized .chat-messages {
            display: none;
        }

        .chat-message {
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .chat-message.user {
            color: #1a73e8;
        }

        .chat-message.bot {
            color: #5f6368;
        }

        .chat-message.bot p {
            margin: 8px 0;
        }

        .chat-message.bot ul, .chat-message.bot ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .chat-message.bot li {
            margin: 4px 0;
        }

        .chat-message.bot code {
            background: #f1f3f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }

        .chat-message.bot strong {
            font-weight: 600;
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid #e1e5e9;
        }

        #chat-container.minimized .chat-input-area {
            display: none;
        }

        .chat-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
        }

        /* Data Management Section */
        .data-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .data-actions .btn {
            flex: 1;
            min-width: 120px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 100;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                width: 100%;
            }

            .tasks-container {
                padding: 20px 16px;
            }

            .main-header {
                padding: 16px 20px;
            }

            #chat-container {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                bottom: 20px;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .data-actions {
                flex-direction: column;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-item {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">Usuario</div>
                        <div style="font-size: 12px; color: #888;">Gestor de tareas</div>
                    </div>
                </div>

                <div class="search-box" style="position: relative; margin-top: 16px;">
                    <input type="text" class="search-input" placeholder="Buscar tareas..." id="searchInput" style="width: 100%; padding: 8px 12px 8px 36px; border: 1px solid #e1e1e1; border-radius: 6px; font-size: 14px; background-color: #f8f8f8;">
                    <div class="search-icon" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #888;">üîç</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Etiquetas</div>
                    <div id="labelsList">
                        <!-- Las etiquetas se cargar√°n din√°micamente -->
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-item active" data-view="today" onclick="switchView('today')">
                        <div class="nav-item-icon">üìÖ</div>
                        <div class="nav-item-text">Hoy</div>
                        <div class="nav-item-count" id="todayCount">0</div>
                    </div>
                    <div class="nav-item" data-view="upcoming" onclick="switchView('upcoming')">
                        <div class="nav-item-icon">üìÜ</div>
                        <div class="nav-item-text">Pr√≥ximamente</div>
                        <div class="nav-item-count" id="upcomingCount">0</div>
                    </div>
                    <div class="nav-item" data-view="inbox" onclick="switchView('inbox')">
                        <div class="nav-item-icon">üì•</div>
                        <div class="nav-item-text">Bandeja de entrada</div>
                        <div class="nav-item-count" id="inboxCount">0</div>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Favoritos</div>
                    <div class="nav-item" data-view="important" onclick="switchView('important')">
                        <div class="nav-item-icon">‚≠ê</div>
                        <div class="nav-item-text">Importante</div>
                        <div class="nav-item-count" id="importantCount">0</div>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Proyectos</div>
                    <div id="projectsList">
                        <!-- Los proyectos se cargar√°n din√°micamente -->
                    </div>
                    <div class="nav-item" onclick="showProjectModal()">
                        <div class="nav-item-icon">‚ûï</div>
                        <div class="nav-item-text">A√±adir proyecto</div>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Filtros</div>
                    <div class="nav-item" data-view="all" onclick="switchView('all')">
                        <div class="nav-item-icon">üìã</div>
                        <div class="nav-item-text">Todas las tareas</div>
                        <div class="nav-item-count" id="allCount">0</div>
                    </div>
                    <div class="nav-item" data-view="completed" onclick="switchView('completed')">
                        <div class="nav-item-icon">‚úÖ</div>
                        <div class="nav-item-text">Completadas</div>
                        <div class="nav-item-count" id="completedCount">0</div>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">IA Settings</div>
                    <div class="nav-item" onclick="showAIConfigModal()">
                        <div class="nav-item-icon">‚öôÔ∏è</div>
                        <div class="nav-item-text">Configurar IA</div>
                    </div>
                    <div class="nav-item" onclick="showAIStatsModal()">
                        <div class="nav-item-icon">üìä</div>
                        <div class="nav-item-text">Estad√≠sticas</div>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Gesti√≥n de Datos</div>
                    <div class="nav-item" onclick="showDataManagementModal()">
                        <div class="nav-item-icon">üíæ</div>
                        <div class="nav-item-text">Importar/Exportar</div>
                    </div>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <header class="main-header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                    <h1 class="main-title" id="mainTitle">Hoy</h1>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="showTaskModal()">
                        <span>‚ûï</span>
                        A√±adir tarea
                    </button>
                </div>
            </header>

            <div class="tasks-container">
                <div class="task-form">
                    <h3 style="margin: 0 0 16px 0; color: #202124; font-size: 18px;">Nueva tarea</h3>
                    <form id="task-form">
                        <div class="form-row">
                            <input type="text" id="task-name" placeholder="Nombre de la tarea" required />
                            <select id="task-priority">
                                <option value="baja">Prioridad baja</option>
                                <option value="media">Prioridad media</option>
                                <option value="alta">Prioridad alta</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <textarea id="task-description" placeholder="Descripci√≥n (opcional)"></textarea>
                        </div>
                        <div class="form-row">
                            <select id="task-project">
                                <option value="">Sin proyecto</option>
                            </select>
                            <input type="datetime-local" id="task-date" />
                        </div>
                        <div class="form-row">
                            <input type="text" id="task-tags" placeholder="Etiquetas (presiona Enter para agregar)" />
                        </div>
                        <div class="form-row">
                            <input type="text" id="task-subtasks" placeholder="Subtareas (presiona Enter para agregar)" />
                        </div>
                        <div id="selected-tags" style="margin-bottom: 12px;"></div>
                        <div id="selected-subtasks" style="margin-bottom: 12px;"></div>
                        <button type="submit" class="add-btn">A√±adir tarea</button>
                    </form>
                </div>

                <div class="tasks-list" id="tasksList">
                    <!-- Las tareas se cargar√°n din√°micamente -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">üìã</div>
                    <div class="empty-title">Sin tareas</div>
                    <div class="empty-description">¬°A√±ade tu primera tarea para comenzar!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar tareas -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Detalles de la tarea</h2>
                <button class="modal-close" onclick="hideTaskModal()">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">T√≠tulo</label>
                <input type="text" class="form-input" id="modalTaskTitle" placeholder="Nombre de la tarea">
            </div>
            <div class="form-group">
                <label class="form-label">Descripci√≥n</label>
                <textarea class="form-input form-textarea" id="modalTaskDescription" placeholder="Descripci√≥n de la tarea"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Proyecto</label>
                <select class="form-select" id="modalTaskProject">
                    <option value="">Sin proyecto</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Fecha l√≠mite</label>
                <input type="datetime-local" class="form-input" id="modalTaskDate">
            </div>
            <div class="form-group">
                <label class="form-label">Prioridad</label>
                <select class="form-select" id="modalTaskPriority">
                    <option value="alta">Prioridad alta</option>
                    <option value="media">Prioridad media</option>
                    <option value="baja" selected>Prioridad baja</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Etiquetas</label>
                <input type="text" class="form-input" id="modalTaskLabels" placeholder="A√±adir etiqueta y presionar Enter">
                <div class="selected-labels" id="selectedLabels"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Subtareas</label>
                <div class="subtasks-editor">
                    <div class="subtasks-list" id="modalSubtasksList"></div>
                    <input type="text" class="form-input" id="newSubtaskInput" placeholder="A√±adir subtarea y presionar Enter">
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="saveTask()" style="width: 100%;">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para proyectos -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projectModalTitle">Nuevo proyecto</h2>
                <button class="modal-close" onclick="hideProjectModal()">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Nombre del proyecto</label>
                <input type="text" class="form-input" id="projectNameInput" placeholder="Mi proyecto">
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <select class="form-select" id="projectColorInput">
                    <option value="#db4035">üî¥ Rojo</option>
                    <option value="#ff9933">üü† Naranja</option>
                    <option value="#fad000">üü° Amarillo</option>
                    <option value="#299438">üü¢ Verde</option>
                    <option value="#6accbc">üîµ Azul claro</option>
                    <option value="#158fad">üî∑ Azul</option>
                    <option value="#14aaf5">üíô Azul cielo</option>
                    <option value="#96c3eb">ü©µ Azul pastel</option>
                    <option value="#884dff">üü£ Morado</option>
                    <option value="#af38eb">üü™ Rosa</option>
                </select>
            </div>
            <div class="form-group" style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="saveProject()" style="flex: 1;">Guardar</button>
                <button class="btn btn-danger" id="deleteProjectBtn" onclick="deleteProject()" style="display: none;">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n de IA -->
    <div class="modal" id="aiConfigModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Configuraci√≥n de IA</h2>
                <button class="modal-close" onclick="hideAIConfigModal()">√ó</button>
            </div>

            <div class="warning-box" id="costWarning" style="display: none;">
                <h4>‚ö†Ô∏è Advertencia de Costos</h4>
                <p>El modelo GPT-4 es considerablemente m√°s caro. Se recomienda usar GPT-3.5-turbo para reducir costos en un 90%.</p>
            </div>

            <div class="config-grid">
                <div class="config-item full-width">
                    <label class="form-label">üîë API Key de OpenAI</label>
                    <input type="password" class="form-input" id="aiApiKey" placeholder="sk-..." value="">
                    <small style="color: #666; font-size: 12px;">Tu API key se guarda localmente y nunca se comparte</small>
                </div>

                <div class="config-item">
                    <label class="form-label">ü§ñ Modelo de IA</label>
                    <select class="form-select" id="aiModel">
                        <option value="gpt-4.1-nano">GPT-4.1 nano (Recomendado)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Econ√≥mico)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo (Balanceado)</option>
                        <option value="gpt-4">GPT-4 (M√°s caro)</option>
                    </select>
                </div>

                <div class="config-item">
                    <label class="form-label">üìè M√°x. tokens respuesta</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="maxTokens" min="100" max="4000" value="1000" step="100">
                        <div class="slider-value" id="maxTokensValue">1000</div>
                    </div>
                </div>

                <div class="config-item">
                    <label class="form-label">üéØ Temperatura (creatividad)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="temperature" min="0" max="2" value="0.7" step="0.1">
                        <div class="slider-value" id="temperatureValue">0.7</div>
                    </div>
                </div>

                <div class="config-item">
                    <label class="form-label">üí≠ L√≠mite historial mensajes</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="historyLimit" min="5" max="50" value="10" step="5">
                        <div class="slider-value" id="historyLimitValue">10</div>
                    </div>
                </div>

                <div class="config-item full-width">
                    <div class="cost-indicator">
                        <h4>üí∞ Costo estimado por consulta</h4>
                        <div class="cost-value" id="costEstimate">~$0.01</div>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveAIConfig()" style="width: 100%;">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal de Estad√≠sticas de IA -->
    <div class="modal" id="aiStatsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">üìä Estad√≠sticas de Uso de IA</h2>
                <button class="modal-close" onclick="hideAIStatsModal()">√ó</button>
            </div>

            <div class="stats-grid">
                <div class="stats-card">
                    <h4>Consultas Hoy</h4>
                    <div class="stats-value" id="todayQueries">0</div>
                </div>
                <div class="stats-card">
                    <h4>Tokens Usados</h4>
                    <div class="stats-value" id="tokensUsed">0</div>
                </div>
                <div class="stats-card">
                    <h4>Costo Estimado</h4>
                    <div class="stats-value" id="estimatedCost">$0.00</div>
                </div>
                <div class="stats-card">
                    <h4>Modelo Actual</h4>
                    <div class="stats-value" id="currentModel">GPT-4.1 nano</div>
                </div>
            </div>

            <div class="form-group">
                <h3 style="margin-bottom: 12px;">üìà Historial de Uso</h3>
                <div style="background: #f8f9fa; border-radius: 6px; padding: 16px; max-height: 200px; overflow-y: auto;">
                    <div id="usageHistory">
                        <!-- El historial se cargar√° din√°micamente -->
                    </div>
                </div>
            </div>

            <div class="form-group" style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="exportStats()" style="flex: 1;">üì§ Exportar</button>
                <button class="btn btn-secondary" onclick="clearStats()" style="flex: 1;">üóëÔ∏è Limpiar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Datos -->
    <div class="modal" id="dataManagementModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">üíæ Gesti√≥n de Datos</h2>
                <button class="modal-close" onclick="hideDataManagementModal()">√ó</button>
            </div>

            <div class="form-group">
                <h3 style="margin-bottom: 12px;">üì§ Exportar Datos</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                    Exporta todas tus tareas, proyectos y configuraci√≥n para hacer respaldo o transferir a otro dispositivo.
                </p>
                <div class="data-actions">
                    <button class="btn btn-primary" onclick="exportAllData()">
                        üì§ Exportar Todo
                    </button>
                    <button class="btn btn-secondary" onclick="exportTasks()">
                        üìã Solo Tareas
                    </button>
                    <button class="btn btn-secondary" onclick="exportProjects()">
                        üìÅ Solo Proyectos
                    </button>
                </div>
            </div>

            <div class="form-group">
                <h3 style="margin-bottom: 12px;">üì• Importar Datos</h3>
                <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
                    Importa datos previamente exportados. <strong>Advertencia:</strong> Esto reemplazar√° todos los datos actuales.
                </p>
                <input type="file" id="importFileInput" accept=".json" style="margin-bottom: 16px;" />
                <div class="data-actions">
                    <button class="btn btn-primary" onclick="importData()">
                        üì• Importar Datos
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è Limpiar Todo
                    </button>
                </div>
            </div>

            <div class="warning-box">
                <h4>‚ö†Ô∏è Importante</h4>
                <p>Siempre haz una copia de seguridad antes de importar datos o limpiar. Los datos eliminados no se pueden recuperar.</p>
            </div>
        </div>
    </div>

    <!-- Chat del asistente -->
    <div id="chat-container">
        <div class="chat-header">
            ü§ñ Asistente de Tareas
            <button class="chat-minimize-btn" onclick="toggleChat()" id="chatMinimizeBtn">‚àí</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chat-input" placeholder="Escribe tu mensaje..." onkeypress="if(event.key==='Enter') enviarMensaje()">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // Variables globales
        let appData = {
            tasks: [],
            projects: [
                { id: 1, name: 'Trabajo', color: '#db4035' },
                { id: 2, name: 'Personal', color: '#ff9933' },
                { id: 3, name: 'Estudio', color: '#299438' }
            ],
            currentView: 'today',
            editingTask: null,
            editingProject: null
        };

        let taskIdCounter = 1;
        let projectIdCounter = 4;
        let subtaskIdCounter = 1000;

        // Configuraci√≥n de IA con valores por defecto optimizados
        let aiConfig = {
            apiKey: '',
            model: 'gpt-4.1-nano',
            maxTokens: 1000,
            temperature: 0.7,
            historyLimit: 10
        };

        // Estad√≠sticas de uso
        let aiStats = {
            todayQueries: 0,
            totalTokens: 0,
            estimatedCost: 0,
            usageHistory: [],
            currentModel: 'GPT-4.1 nano',
            lastResetDate: new Date().toDateString()
        };

        // Precios por modelo (por 1K tokens)
        const modelPricing = {
            'gpt-3.5-turbo': { input: 0.0015, output: 0.002 },
            'gpt-4-turbo': { input: 0.01, output: 0.03 },
            'gpt-4': { input: 0.03, output: 0.06 },
            'gpt-4.1-nano': { input: 0.0015, output: 0.002 } 
        };

        // Funciones de almacenamiento mejoradas
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    tasks: appData.tasks,
                    projects: appData.projects,
                    taskIdCounter: taskIdCounter,
                    projectIdCounter: projectIdCounter,
                    subtaskIdCounter: subtaskIdCounter
                };
                localStorage.setItem('todoistData', JSON.stringify(dataToSave));
                console.log('Datos guardados correctamente');
            } catch (error) {
                console.error('Error guardando datos:', error);
                mostrarMensajeChat('‚ùå Error guardando datos localmente');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('todoistData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    appData.tasks = data.tasks || [];
                    appData.projects = data.projects || appData.projects;
                    taskIdCounter = data.taskIdCounter || 1;
                    projectIdCounter = data.projectIdCounter || 4;
                    subtaskIdCounter = data.subtaskIdCounter || 1000;
                    console.log('Datos cargados correctamente');
                }
            } catch (e) {
                console.error('Error cargando datos:', e);
                mostrarMensajeChat('‚ùå Error cargando datos guardados');
            }
        }

        function saveAIConfigToStorage() {
            try {
                localStorage.setItem('aiConfig', JSON.stringify(aiConfig));
                localStorage.setItem('aiStats', JSON.stringify(aiStats));
                console.log('Configuraci√≥n de IA guardada');
            } catch (error) {
                console.error('Error guardando configuraci√≥n de IA:', error);
            }
        }

        function loadAIConfig() {
            try {
                const savedConfig = localStorage.getItem('aiConfig');
                const savedStats = localStorage.getItem('aiStats');
                
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    aiConfig = { ...aiConfig, ...config };
                    console.log('Configuraci√≥n de IA cargada');
                }
                
                if (savedStats) {
                    const stats = JSON.parse(savedStats);
                    // Reset daily stats if it's a new day
                    if (stats.lastResetDate !== new Date().toDateString()) {
                        stats.todayQueries = 0;
                        stats.lastResetDate = new Date().toDateString();
                    }
                    aiStats = { ...aiStats, ...stats };
                    console.log('Estad√≠sticas de IA cargadas');
                }
            } catch (e) {
                console.error('Error cargando configuraci√≥n de IA:', e);
            }
        }

        // Clase Assistant mejorada con acciones m√∫ltiples
        class Assistant {
            constructor() {
                this.mensajes = JSON.parse(localStorage.getItem('assistantMessages')) || [];
                this.promptBase = "Eres un asistente que ayuda con tareas y notas, gestion√°ndolas en tiempo real. " +
                    "Puedes agregar, editar, eliminar m√∫ltiples tareas en una sola consulta. " +
                    "Cada tarea tiene un ID √∫nico. Para editar o eliminar, usa el ID de la tarea espec√≠fica. " +
                    "Cuando muestres las tareas al usuario, siempre incluye su ID para referencia. " +
                    "Puedes realizar operaciones en lote como 'eliminar tareas 1, 2, 3' o 'marcar como completadas las tareas 4, 5, 6'. " +
                    "S√© conciso y directo en tus respuestas para optimizar costos.";
            }

            cleanHistory() {
                if (this.mensajes.length > aiConfig.historyLimit * 2) {
                    const keepCount = aiConfig.historyLimit;
                    this.mensajes = this.mensajes.slice(-keepCount);
                    localStorage.setItem('assistantMessages', JSON.stringify(this.mensajes));
                }
            }

            async obtenerTareas() {
                const tareas = appData.tasks.map(task => {
                    const proyecto = task.projectId ? appData.projects.find(p => p.id === task.projectId) : null;
                    
                    return {
                        id: task.id,
                        titulo: task.title,
                        descripcion: task.description,
                        completada: task.completed,
                        prioridad: task.priority,
                        fecha: task.dueDate,
                        proyecto: proyecto?.name || null,
                        etiquetas: task.labels,
                        subtareas: task.subtasks
                    };
                });

                let respuesta = "## üìã Tareas\n\n";
                
                if (tareas.length === 0) {
                    respuesta += "*Sin tareas.*";
                } else {
                    tareas.forEach(tarea => {
                        const estado = tarea.completada ? "‚úÖ" : "‚è≥";
                        const prioEmoji = tarea.prioridad === 'alta' ? 'üî¥' : tarea.prioridad === 'media' ? 'üü°' : '‚ö™';
                        
                        respuesta += `**${tarea.titulo}** (ID: ${tarea.id}) ${estado} ${prioEmoji}\n`;
                        
                        if (tarea.descripcion) respuesta += `*${tarea.descripcion}*\n`;
                        if (tarea.fecha) respuesta += `üìÖ ${new Date(tarea.fecha).toLocaleDateString()}\n`;
                        if (tarea.proyecto) respuesta += `üìÅ ${tarea.proyecto}\n`;
                        if (tarea.etiquetas?.length) respuesta += `üè∑Ô∏è ${tarea.etiquetas.map(e => `#${e}`).join(' ')}\n`;
                        
                        respuesta += "\n";
                    });
                }
                
                return respuesta;
            }

            async agregarTareas(tareas) {
                const tareasArray = Array.isArray(tareas) ? tareas : [tareas];
                const resultados = [];
                
                for (const tarea of tareasArray) {
                    const nuevaTarea = {
                        id: taskIdCounter++,
                        title: tarea.titulo || tarea.name || tarea.title,
                        description: tarea.descripcion || tarea.description || '',
                        completed: false,
                        priority: tarea.prioridad || tarea.priority || 'baja',
                        dueDate: tarea.fecha || tarea.date || null,
                        projectId: tarea.proyectoId || tarea.projectId || null,
                        labels: tarea.etiquetas || tarea.labels || [],
                        subtasks: (tarea.subtareas || tarea.subtasks || []).map(sub => ({
                            id: subtaskIdCounter++,
                            title: typeof sub === 'string' ? sub : sub.title || sub.titulo,
                            completed: false
                        })),
                        createdAt: new Date().toISOString()
                    };
                    
                    appData.tasks.push(nuevaTarea);
                    resultados.push(`‚úÖ Tarea agregada (ID: ${nuevaTarea.id}): "${nuevaTarea.title}"`);
                }
                
                saveToLocalStorage();
                renderTasks();
                updateCounts();
                return resultados.join('\n');
            }

            async editarTareas(tareasAEditar) {
                const resultados = [];
                const tareasArray = Array.isArray(tareasAEditar) ? tareasAEditar : [tareasAEditar];
                
                for (const edicion of tareasArray) {
                    const taskId = edicion.taskId || edicion.id;
                    const cambios = edicion.cambios || edicion;
                    
                    const taskIndex = appData.tasks.findIndex(t => t.id === parseInt(taskId));
                    if (taskIndex === -1) {
                        resultados.push(`‚ùå No encontr√© tarea ID ${taskId}`);
                        continue;
                    }

                    const task = appData.tasks[taskIndex];
                    
                    if (cambios.titulo || cambios.title) task.title = cambios.titulo || cambios.title;
                    if (cambios.descripcion || cambios.description) task.description = cambios.descripcion || cambios.description;
                    if (cambios.prioridad || cambios.priority) task.priority = cambios.prioridad || cambios.priority;
                    if (cambios.fecha || cambios.date) task.dueDate = cambios.fecha || cambios.date;
                    if (cambios.completada !== undefined || cambios.completed !== undefined) {
                        task.completed = cambios.completada !== undefined ? cambios.completada : cambios.completed;
                        task.completedAt = task.completed ? new Date().toISOString() : null;
                    }
                    if (cambios.etiquetas || cambios.labels) task.labels = cambios.etiquetas || cambios.labels;
                    
                    resultados.push(`‚úÖ Tarea ID ${taskId} actualizada: "${task.title}"`);
                }
                
                saveToLocalStorage();
                renderTasks();
                updateCounts();
                return resultados.join('\n');
            }

            async eliminarTareas(taskIds) {
                const idsArray = Array.isArray(taskIds) ? taskIds : [taskIds];
                const resultados = [];
                
                for (const taskId of idsArray) {
                    const taskIndex = appData.tasks.findIndex(t => t.id === parseInt(taskId));
                    if (taskIndex === -1) {
                        resultados.push(`‚ùå No encontr√© tarea ID ${taskId}`);
                        continue;
                    }

                    const task = appData.tasks[taskIndex];
                    appData.tasks.splice(taskIndex, 1);
                    resultados.push(`üóëÔ∏è Eliminada: "${task.title}" (ID: ${taskId})`);
                }
                
                saveToLocalStorage();
                renderTasks();
                updateCounts();
                return resultados.join('\n');
            }

            async marcarCompletadas(taskIds) {
                const idsArray = Array.isArray(taskIds) ? taskIds : [taskIds];
                return await this.editarTareas(idsArray.map(id => ({
                    taskId: id,
                    cambios: { completada: true }
                })));
            }

            async marcarPendientes(taskIds) {
                const idsArray = Array.isArray(taskIds) ? taskIds : [taskIds];
                return await this.editarTareas(idsArray.map(id => ({
                    taskId: id,
                    cambios: { completada: false }
                })));
            }

            async consultarConFunciones(pregunta) {
                if (!aiConfig.apiKey) {
                    return 'üîë **Error:** No has configurado tu API Key de OpenAI. Ve a Configurar IA en el sidebar.';
                }

                this.mensajes.push({ role: 'user', content: pregunta });
                this.cleanHistory();

                const mensajesAPI = [
                    { role: 'system', content: this.promptBase },
                    ...this.mensajes
                ];

                try {
                    const startTime = Date.now();
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${aiConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: aiConfig.model,
                            messages: mensajesAPI,
                            max_tokens: aiConfig.maxTokens,
                            temperature: aiConfig.temperature,
                            functions: [
                                {
                                    name: 'obtenerTareas',
                                    description: 'Devuelve la lista de tareas con sus IDs √∫nicos.',
                                    parameters: { type: 'object', properties: {} }
                                },
                                {
                                    name: 'agregarTareas',
                                    description: 'Agrega una o m√∫ltiples tareas nuevas.',
                                    parameters: { 
                                        type: 'object', 
                                        properties: { 
                                            tareas: { 
                                                type: 'array',
                                                items: {
                                                    type: 'object',
                                                    properties: {
                                                        titulo: { type: 'string', description: 'T√≠tulo de la tarea' },
                                                        descripcion: { type: 'string', description: 'Descripci√≥n opcional' },
                                                        prioridad: { type: 'string', enum: ['alta', 'media', 'baja'], description: 'Prioridad de la tarea' },
                                                        fecha: { type: 'string', description: 'Fecha l√≠mite en formato ISO' },
                                                        etiquetas: { type: 'array', items: { type: 'string' }, description: 'Lista de etiquetas' },
                                                        subtareas: { type: 'array', items: { type: 'string' }, description: 'Lista de subtareas' }
                                                    },
                                                    required: ['titulo']
                                                }
                                            }
                                        }, 
                                        required: ['tareas'] 
                                    }
                                },
                                {
                                    name: 'editarTareas',
                                    description: 'Edita una o m√∫ltiples tareas existentes usando sus IDs √∫nicos.',
                                    parameters: { 
                                        type: 'object', 
                                        properties: { 
                                            tareasAEditar: {
                                                type: 'array',
                                                items: {
                                                    type: 'object',
                                                    properties: {
                                                        taskId: { type: 'integer', description: 'ID √∫nico de la tarea a editar' },
                                                        cambios: { 
                                                            type: 'object',
                                                            properties: {
                                                                titulo: { type: 'string' },
                                                                descripcion: { type: 'string' },
                                                                prioridad: { type: 'string', enum: ['alta', 'media', 'baja'] },
                                                                fecha: { type: 'string' },
                                                                completada: { type: 'boolean' },
                                                                etiquetas: { type: 'array', items: { type: 'string' } }
                                                            }
                                                        }
                                                    },
                                                    required: ['taskId', 'cambios']
                                                }
                                            }
                                        }, 
                                        required: ['tareasAEditar'] 
                                    }
                                },
                                {
                                    name: 'eliminarTareas',
                                    description: 'Elimina una o m√∫ltiples tareas usando sus IDs √∫nicos.',
                                    parameters: { 
                                        type: 'object', 
                                        properties: { 
                                            taskIds: { 
                                                type: 'array',
                                                items: { type: 'integer' },
                                                description: 'Array de IDs √∫nicos de las tareas a eliminar'
                                            }
                                        }, 
                                        required: ['taskIds'] 
                                    }
                                },
                                {
                                    name: 'marcarCompletadas',
                                    description: 'Marca una o m√∫ltiples tareas como completadas usando sus IDs.',
                                    parameters: { 
                                        type: 'object', 
                                        properties: { 
                                            taskIds: { 
                                                type: 'array',
                                                items: { type: 'integer' },
                                                description: 'Array de IDs √∫nicos de las tareas'
                                            }
                                        }, 
                                        required: ['taskIds'] 
                                    }
                                },
                                {
                                    name: 'marcarPendientes',
                                    description: 'Marca una o m√∫ltiples tareas como pendientes usando sus IDs.',
                                    parameters: { 
                                        type: 'object', 
                                        properties: { 
                                            taskIds: { 
                                                type: 'array',
                                                items: { type: 'integer' },
                                                description: 'Array de IDs √∫nicos de las tareas'
                                            }
                                        }, 
                                        required: ['taskIds'] 
                                    }
                                }
                            ],
                        })
                    });

                    const data = await response.json();
                    const endTime = Date.now();

                    if (!response.ok) {
                        console.error('Error en la API:', data);
                        return '‚ùå **Error API:** ' + (data.error ? data.error.message : `Estado ${response.status}`);
                    }

                    // Tracking de uso y costos
                    if (data.usage) {
                        const { prompt_tokens, completion_tokens, total_tokens } = data.usage;
                        const pricing = modelPricing[aiConfig.model];
                        const cost = (prompt_tokens * pricing.input / 1000) + (completion_tokens * pricing.output / 1000);
                        
                        aiStats.todayQueries++;
                        aiStats.totalTokens += total_tokens;
                        aiStats.estimatedCost += cost;
                        aiStats.usageHistory.push({
                            timestamp: new Date().toLocaleTimeString(),
                            model: aiConfig.model,
                            tokens: total_tokens,
                            cost: cost,
                            responseTime: endTime - startTime
                        });
                        
                        saveAIConfigToStorage();
                    }

                    if (data.choices && data.choices.length > 0) {
                        const msg = data.choices[0].message;
                        if (msg.hasOwnProperty('function_call')) {
                            const nombreFuncion = msg.function_call.name;
                            const args = JSON.parse(msg.function_call.arguments);
                            let resultado;
                            
                            switch(nombreFuncion) {
                                case 'obtenerTareas':
                                    resultado = await this.obtenerTareas();
                                    break;
                                case 'agregarTareas':
                                    resultado = await this.agregarTareas(args.tareas);
                                    break;
                                case 'editarTareas':
                                    resultado = await this.editarTareas(args.tareasAEditar);
                                    break;
                                case 'eliminarTareas':
                                    resultado = await this.eliminarTareas(args.taskIds);
                                    break;
                                case 'marcarCompletadas':
                                    resultado = await this.marcarCompletadas(args.taskIds);
                                    break;
                                case 'marcarPendientes':
                                    resultado = await this.marcarPendientes(args.taskIds);
                                    break;
                                default:
                                    resultado = '‚ùå Funci√≥n no reconocida.';
                            }

                            this.mensajes.push({ 
                                role: 'function', 
                                name: nombreFuncion, 
                                content: resultado 
                            });
                            
                            const finalResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${aiConfig.apiKey}`
                                },
                                body: JSON.stringify({
                                    model: aiConfig.model,
                                    messages: [
                                        { role: 'system', content: this.promptBase + " Responde de forma muy concisa." },
                                        ...this.mensajes.slice(-3),
                                        { role: 'user', content: "Resume brevemente lo que acabas de hacer." }
                                    ],
                                    max_tokens: Math.min(aiConfig.maxTokens, 200),
                                    temperature: 0.3
                                })
                            });

                            const finalData = await finalResponse.json();
                            if (finalData.choices && finalData.choices.length > 0) {
                                const finalMsg = finalData.choices[0].message.content;
                                this.mensajes.push({ role: 'assistant', content: finalMsg });
                                localStorage.setItem('assistantMessages', JSON.stringify(this.mensajes));
                                return finalMsg;
                            }
                            
                            return resultado;
                            
                        } else {
                            this.mensajes.push({ role: 'assistant', content: msg.content });
                            localStorage.setItem('assistantMessages', JSON.stringify(this.mensajes));
                            return msg.content;
                        }
                    } else {
                        return "‚ùå Respuesta no v√°lida de la API.";
                    }
                } catch (error) {
                    console.error('Error:', error);
                    return '‚ùå **Error de conexi√≥n:** ' + error.message;
                }
            }
        }

        const assistant = new Assistant();

        // Funciones de configuraci√≥n de IA
        function showAIConfigModal() {
            document.getElementById('aiConfigModal').classList.add('active');
            
            document.getElementById('aiApiKey').value = aiConfig.apiKey;
            document.getElementById('aiModel').value = aiConfig.model;
            document.getElementById('maxTokens').value = aiConfig.maxTokens;
            document.getElementById('temperature').value = aiConfig.temperature;
            document.getElementById('historyLimit').value = aiConfig.historyLimit;
            
            updateSliderValues();
            updateCostEstimate();
            updateCostWarning();
        }

        function hideAIConfigModal() {
            document.getElementById('aiConfigModal').classList.remove('active');
        }

        function updateSliderValues() {
            document.getElementById('maxTokensValue').textContent = document.getElementById('maxTokens').value;
            document.getElementById('temperatureValue').textContent = document.getElementById('temperature').value;
            document.getElementById('historyLimitValue').textContent = document.getElementById('historyLimit').value;
        }

        function updateCostEstimate() {
            const model = document.getElementById('aiModel').value;
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const pricing = modelPricing[model];
            
            if (pricing) {
                const estimatedInputTokens = 500;
                const estimatedOutputTokens = maxTokens;
                const cost = (estimatedInputTokens * pricing.input / 1000) + (estimatedOutputTokens * pricing.output / 1000);
                document.getElementById('costEstimate').textContent = `~$${cost.toFixed(4)}`;
                return cost.toFixed(4);
            }
            return '0.01';
        }

        function updateCostWarning() {
            const model = document.getElementById('aiModel').value;
            const warning = document.getElementById('costWarning');
            
            if (model === 'gpt-4' || model === 'gpt-4-turbo') {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        function saveAIConfig() {
            aiConfig.apiKey = document.getElementById('aiApiKey').value;
            aiConfig.model = document.getElementById('aiModel').value;
            aiConfig.maxTokens = parseInt(document.getElementById('maxTokens').value);
            aiConfig.temperature = parseFloat(document.getElementById('temperature').value);
            aiConfig.historyLimit = parseInt(document.getElementById('historyLimit').value);
            
            saveAIConfigToStorage();
            hideAIConfigModal();
            
            mostrarMensajeChat('‚úÖ Configuraci√≥n de IA guardada correctamente');
        }

        function showAIStatsModal() {
            document.getElementById('aiStatsModal').classList.add('active');
            updateStatsDisplay();
        }

        function hideAIStatsModal() {
            document.getElementById('aiStatsModal').classList.remove('active');
        }

        function updateStatsDisplay() {
            document.getElementById('todayQueries').textContent = aiStats.todayQueries;
            document.getElementById('tokensUsed').textContent = aiStats.totalTokens.toLocaleString();
            document.getElementById('estimatedCost').textContent = `$${aiStats.estimatedCost.toFixed(4)}`;
            document.getElementById('currentModel').textContent = aiConfig.model.replace('gpt-', 'GPT-').replace('-turbo', ' Turbo').replace('4.1-nano', '4.1 nano');
            
            const historyContainer = document.getElementById('usageHistory');
            if (aiStats.usageHistory.length === 0) {
                historyContainer.innerHTML = '<p style="color: #666; font-style: italic;">No hay historial de uso</p>';
            } else {
                historyContainer.innerHTML = aiStats.usageHistory.slice(-10).map(entry => `
                    <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                        <strong>${entry.timestamp}</strong> - ${entry.model} - ${entry.tokens} tokens - $${entry.cost.toFixed(4)}
                    </div>
                `).join('');
            }
        }

        function exportStats() {
            const dataStr = JSON.stringify(aiStats, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ai-stats-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            mostrarMensajeChat('üì§ Estad√≠sticas exportadas correctamente');
        }

        function clearStats() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todas las estad√≠sticas?')) {
                aiStats = {
                    todayQueries: 0,
                    totalTokens: 0,
                    estimatedCost: 0,
                    usageHistory: [],
                    currentModel: aiConfig.model.replace('gpt-', 'GPT-').replace('-turbo', ' Turbo').replace('4.1-nano', '4.1 nao'),
                    lastResetDate: new Date().toDateString()
                };
                saveAIConfigToStorage();
                updateStatsDisplay();
                mostrarMensajeChat('üóëÔ∏è Estad√≠sticas limpiadas');
            }
        }

        // Funciones de gesti√≥n de datos
        function showDataManagementModal() {
            document.getElementById('dataManagementModal').classList.add('active');
        }

        function hideDataManagementModal() {
            document.getElementById('dataManagementModal').classList.remove('active');
        }

        function exportAllData() {
            const allData = {
                tasks: appData.tasks,
                projects: appData.projects,
                aiConfig: aiConfig,
                aiStats: aiStats,
                counters: {
                    taskIdCounter,
                    projectIdCounter,
                    subtaskIdCounter
                },
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `task-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            mostrarMensajeChat('üì§ Todos los datos exportados correctamente');
        }

        function exportTasks() {
            const tasksData = {
                tasks: appData.tasks,
                counters: { taskIdCounter, subtaskIdCounter },
                exportDate: new Date().toISOString(),
                type: 'tasks-only'
            };
            
            const dataStr = JSON.stringify(tasksData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tasks-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            mostrarMensajeChat('üì§ Tareas exportadas correctamente');
        }

        function exportProjects() {
            const projectsData = {
                projects: appData.projects,
                counters: { projectIdCounter },
                exportDate: new Date().toISOString(),
                type: 'projects-only'
            };
            
            const dataStr = JSON.stringify(projectsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `projects-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            mostrarMensajeChat('üì§ Proyectos exportados correctamente');
        }

        function importData() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarMensajeChat('‚ùå Por favor selecciona un archivo para importar');
                return;
            }

            if (file.type !== 'application/json') {
                mostrarMensajeChat('‚ùå Por favor selecciona un archivo JSON v√°lido');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esto reemplazar√° todos los datos actuales. Esta acci√≥n no se puede deshacer.')) {
                        return;
                    }

                    // Validar estructura b√°sica
                    if (importedData.tasks && Array.isArray(importedData.tasks)) {
                        appData.tasks = importedData.tasks;
                    }
                    
                    if (importedData.projects && Array.isArray(importedData.projects)) {
                        appData.projects = importedData.projects;
                    }
                    
                    if (importedData.aiConfig) {
                        aiConfig = { ...aiConfig, ...importedData.aiConfig };
                    }
                    
                    if (importedData.aiStats) {
                        aiStats = { ...aiStats, ...importedData.aiStats };
                    }
                    
                    if (importedData.counters) {
                        taskIdCounter = importedData.counters.taskIdCounter || taskIdCounter;
                        projectIdCounter = importedData.counters.projectIdCounter || projectIdCounter;
                        subtaskIdCounter = importedData.counters.subtaskIdCounter || subtaskIdCounter;
                    }
                    
                    // Guardar todo
                    saveToLocalStorage();
                    saveAIConfigToStorage();
                    
                    // Actualizar interfaz
                    renderTasks();
                    renderProjects();
                    renderLabels();
                    updateCounts();
                    
                    hideDataManagementModal();
                    mostrarMensajeChat('‚úÖ Datos importados correctamente');
                    
                } catch (error) {
                    console.error('Error importing data:', error);
                    mostrarMensajeChat('‚ùå Error al importar datos: Archivo inv√°lido');
                }
            };
            
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s COMPLETAMENTE seguro? Esto eliminar√° TODOS los datos (tareas, proyectos, configuraci√≥n). Esta acci√≥n NO se puede deshacer.')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN: Se eliminar√°n todos tus datos. ¬øContinuar?')) {
                return;
            }
            
            // Limpiar datos
            appData.tasks = [];
            appData.projects = [
                { id: 1, name: 'Trabajo', color: '#db4035' },
                { id: 2, name: 'Personal', color: '#ff9933' },
                { id: 3, name: 'Estudio', color: '#299438' }
            ];
            
            taskIdCounter = 1;
            projectIdCounter = 4;
            subtaskIdCounter = 1000;
            
            // Limpiar configuraci√≥n IA
            aiConfig = {
                apiKey: '',
                model: 'gpt-4.1-nano',
                maxTokens: 1000,
                temperature: 0.7,
                historyLimit: 10
            };
            
            aiStats = {
                todayQueries: 0,
                totalTokens: 0,
                estimatedCost: 0,
                usageHistory: [],
                currentModel: 'GPT-4.1 nano',
                lastResetDate: new Date().toDateString()
            };
            
            // Limpiar localStorage
            localStorage.removeItem('todoistData');
            localStorage.removeItem('aiConfig');
            localStorage.removeItem('aiStats');
            localStorage.removeItem('assistantMessages');
            
            // Actualizar interfaz
            renderTasks();
            renderProjects();
            renderLabels();
            updateCounts();
            
            hideDataManagementModal();
            mostrarMensajeChat('üóëÔ∏è Todos los datos han sido eliminados');
        }

        // Funciones de navegaci√≥n
        function switchView(view) {
            appData.currentView = view;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            
            const titles = {
                today: 'Hoy',
                upcoming: 'Pr√≥ximamente',
                inbox: 'Bandeja de entrada',
                important: 'Importante',
                all: 'Todas las tareas',
                completed: 'Completadas'
            };
            
            document.getElementById('mainTitle').textContent = titles[view] || view;
            renderTasks();
        }

        function switchToLabel(labelName) {
            appData.currentView = 'label';
            appData.selectedLabel = labelName;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-label="${labelName}"]`)?.classList.add('active');
            
            document.getElementById('mainTitle').textContent = `#${labelName}`;
            renderTasks();
        }

        function searchTasks() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            appData.searchQuery = query;
            
            if (query) {
                appData.currentView = 'search';
                document.getElementById('mainTitle').textContent = `B√∫squeda: "${query}"`;
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
            } else {
                switchView('today');
            }
            
            renderTasks();
        }

        function switchToProject(projectId) {
            appData.currentView = 'project';
            appData.selectedProject = projectId;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-project="${projectId}"]`)?.classList.add('active');
            
            const project = appData.projects.find(p => p.id === projectId);
            document.getElementById('mainTitle').textContent = project.name;
            renderTasks();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Gesti√≥n de proyectos mejorada
        function showProjectModal(projectId = null) {
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            const deleteBtn = document.getElementById('deleteProjectBtn');
            
            if (projectId) {
                // Modo edici√≥n
                appData.editingProject = appData.projects.find(p => p.id === projectId);
                title.textContent = 'Editar proyecto';
                document.getElementById('projectNameInput').value = appData.editingProject.name;
                document.getElementById('projectColorInput').value = appData.editingProject.color;
                deleteBtn.style.display = 'block';
            } else {
                // Modo creaci√≥n
                appData.editingProject = null;
                title.textContent = 'Nuevo proyecto';
                document.getElementById('projectNameInput').value = '';
                document.getElementById('projectColorInput').value = '#db4035';
                deleteBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
            document.getElementById('projectNameInput').focus();
        }

        function hideProjectModal() {
            document.getElementById('projectModal').classList.remove('active');
            appData.editingProject = null;
        }

        function saveProject() {
            const name = document.getElementById('projectNameInput').value.trim();
            const color = document.getElementById('projectColorInput').value;
            
            if (!name) {
                mostrarMensajeChat('‚ùå El nombre del proyecto es requerido');
                return;
            }
            
            if (appData.editingProject) {
                // Editar proyecto existente
                appData.editingProject.name = name;
                appData.editingProject.color = color;
                mostrarMensajeChat(`‚úÖ Proyecto "${name}" actualizado correctamente`);
            } else {
                // Crear nuevo proyecto
                const project = {
                    id: projectIdCounter++,
                    name: name,
                    color: color
                };
                appData.projects.push(project);
                mostrarMensajeChat(`‚úÖ Proyecto "${name}" creado correctamente`);
            }
            
            hideProjectModal();
            renderProjects();
            updateProjectSelects();
            saveToLocalStorage();
        }

        function deleteProject() {
            if (!appData.editingProject) return;
            
            const projectName = appData.editingProject.name;
            const tasksInProject = appData.tasks.filter(t => t.projectId === appData.editingProject.id);
            
            let confirmMessage = `¬øEst√°s seguro de que quieres eliminar el proyecto "${projectName}"?`;
            if (tasksInProject.length > 0) {
                confirmMessage += `\n\nEsto tambi√©n mover√° ${tasksInProject.length} tarea(s) a "Sin proyecto".`;
            }
            
            if (confirm(confirmMessage)) {
                // Mover tareas a sin proyecto
                tasksInProject.forEach(task => {
                    task.projectId = null;
                });
                
                // Eliminar proyecto
                appData.projects = appData.projects.filter(p => p.id !== appData.editingProject.id);
                
                hideProjectModal();
                renderProjects();
                renderTasks();
                updateProjectSelects();
                updateCounts();
                saveToLocalStorage();
                
                mostrarMensajeChat(`üóëÔ∏è Proyecto "${projectName}" eliminado correctamente`);
                
                // Si est√°bamos viendo el proyecto eliminado, cambiar vista
                if (appData.currentView === 'project' && appData.selectedProject === appData.editingProject.id) {
                    switchView('today');
                }
            }
        }

        function editProject(projectId) {
            showProjectModal(projectId);
        }

        function updateProjectSelects() {
            const selects = [document.getElementById('task-project'), document.getElementById('modalTaskProject')];
            selects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = `
                        <option value="">Sin proyecto</option>
                        ${appData.projects.map(project => 
                            `<option value="${project.id}">${project.name}</option>`
                        ).join('')}
                    `;
                    select.value = currentValue;
                }
            });
        }

        // Funciones de gesti√≥n de tareas
        function getFilteredTasks() {
            let filtered = [...appData.tasks];
            
            switch (appData.currentView) {
                case 'today':
                    const today = new Date().toISOString().split('T')[0];
                    filtered = filtered.filter(task => 
                        !task.completed && (
                            (task.dueDate && task.dueDate.split('T')[0] === today) || 
                            (task.dueDate && new Date(task.dueDate.split('T')[0]) < new Date(today))
                        )
                    );
                    break;
                case 'upcoming':
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = tomorrow.toISOString().split('T')[0];
                    filtered = filtered.filter(task => 
                        !task.completed && task.dueDate && new Date(task.dueDate.split('T')[0]) >= new Date(tomorrowStr)
                    );
                    break;
                case 'inbox':
                    filtered = filtered.filter(task => !task.completed && !task.projectId);
                    break;
                case 'important':
                    filtered = filtered.filter(task => !task.completed && task.priority === 'alta');
                    break;
                case 'all':
                    filtered = filtered.filter(task => !task.completed);
                    break;
                case 'completed':
                    filtered = filtered.filter(task => task.completed);
                    break;
                case 'project':
                    filtered = filtered.filter(task => task.projectId === appData.selectedProject);
                    break;
                case 'label':
                    filtered = filtered.filter(task => 
                        task.labels && task.labels.includes(appData.selectedLabel)
                    );
                    break;
                case 'search':
                    const query = appData.searchQuery.toLowerCase();
                    filtered = filtered.filter(task => 
                        task.title.toLowerCase().includes(query) ||
                        (task.description && task.description.toLowerCase().includes(query)) ||
                        (task.labels && task.labels.some(label => 
                            label.toLowerCase().includes(query)
                        ))
                    );
                    break;
                default:
                    break;
            }
            
            // Ordenar por prioridad y fecha
            filtered.sort((a, b) => {
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                
                const priorityOrder = { 'alta': 1, 'media': 2, 'baja': 3 };
                const aPriority = priorityOrder[a.priority] || 3;
                const bPriority = priorityOrder[b.priority] || 3;
                
                if (aPriority !== bPriority) return aPriority - bPriority;
                if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                if (a.dueDate && !b.dueDate) return -1;
                if (!a.dueDate && b.dueDate) return 1;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            return filtered;
        }

        function toggleTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                task.completedAt = task.completed ? new Date().toISOString() : null;
                saveToLocalStorage();
                renderTasks();
                updateCounts();
            }
        }

        function toggleSubtask(taskId, subtaskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (task && task.subtasks) {
                const subtask = task.subtasks.find(s => s.id === subtaskId);
                if (subtask) {
                    subtask.completed = !subtask.completed;
                    saveToLocalStorage();
                    renderTasks();
                }
            }
        }

        function deleteTask(taskId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
                appData.tasks = appData.tasks.filter(task => task.id !== taskId);
                saveToLocalStorage();
                renderTasks();
                updateCounts();
                mostrarMensajeChat('üóëÔ∏è Tarea eliminada correctamente');
            }
        }

        function editTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (task) {
                appData.editingTask = task;
                
                document.getElementById('modalTaskTitle').value = task.title;
                document.getElementById('modalTaskDescription').value = task.description || '';
                document.getElementById('modalTaskProject').value = task.projectId || '';
                document.getElementById('modalTaskDate').value = task.dueDate || '';
                document.getElementById('modalTaskPriority').value = task.priority;
                
                loadTaskLabels(task.labels || []);
                loadTaskSubtasks(task.subtasks || []);
                
                showTaskModal();
            }
        }

        function saveTask() {
            const title = document.getElementById('modalTaskTitle').value.trim();
            if (!title) {
                mostrarMensajeChat('‚ùå El t√≠tulo de la tarea es requerido');
                return;
            }
            
            const task = {
                id: appData.editingTask ? appData.editingTask.id : taskIdCounter++,
                title: title,
                description: document.getElementById('modalTaskDescription').value.trim(),
                completed: appData.editingTask ? appData.editingTask.completed : false,
                priority: document.getElementById('modalTaskPriority').value,
                dueDate: document.getElementById('modalTaskDate').value || null,
                projectId: parseInt(document.getElementById('modalTaskProject').value) || null,
                labels: getCurrentTaskLabels(),
                subtasks: getCurrentSubtasks(),
                createdAt: appData.editingTask ? appData.editingTask.createdAt : new Date().toISOString(),
                completedAt: appData.editingTask ? appData.editingTask.completedAt : null
            };
            
            if (appData.editingTask) {
                const index = appData.tasks.findIndex(t => t.id === appData.editingTask.id);
                appData.tasks[index] = task;
                mostrarMensajeChat('‚úÖ Tarea actualizada correctamente');
            } else {
                appData.tasks.push(task);
                mostrarMensajeChat('‚úÖ Tarea creada correctamente');
            }
            
            saveToLocalStorage();
            hideTaskModal();
            renderTasks();
            updateCounts();
        }

        // Funciones de etiquetas y subtareas
        function handleLabelInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const label = input.value.trim();
                
                if (label && !getCurrentTaskLabels().includes(label)) {
                    addTaskLabel(label);
                    input.value = '';
                }
            }
        }

        function addTaskLabel(label) {
            const selectedLabelsContainer = document.getElementById('selectedLabels');
            
            const labelElement = document.createElement('span');
            labelElement.className = 'selected-label';
            labelElement.innerHTML = `
                #${label}
                <button class="remove-label-btn" onclick="removeTaskLabel('${label}')" type="button">√ó</button>
            `;
            
            selectedLabelsContainer.appendChild(labelElement);
        }

        function removeTaskLabel(labelToRemove) {
            const selectedLabelsContainer = document.getElementById('selectedLabels');
            const labelElements = selectedLabelsContainer.querySelectorAll('.selected-label');
            
            labelElements.forEach(element => {
                if (element.textContent.trim().startsWith(`#${labelToRemove}`)) {
                    element.remove();
                }
            });
        }

        function getCurrentTaskLabels() {
            const selectedLabelsContainer = document.getElementById('selectedLabels');
            const labelElements = selectedLabelsContainer.querySelectorAll('.selected-label');
            
            return Array.from(labelElements).map(element => {
                const text = element.textContent.trim();
                return text.substring(1, text.length - 1);
            });
        }

        function loadTaskLabels(labels) {
            const selectedLabelsContainer = document.getElementById('selectedLabels');
            selectedLabelsContainer.innerHTML = '';
            
            labels.forEach(label => {
                addTaskLabel(label);
            });
        }

        function handleSubtaskInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const subtaskTitle = input.value.trim();
                
                if (subtaskTitle) {
                    addSubtask(subtaskTitle);
                    input.value = '';
                }
            }
        }

        function addSubtask(title, completed = false, id = null) {
            const subtasksList = document.getElementById('modalSubtasksList');
            const subtaskId = id || subtaskIdCounter++;
            
            const subtaskElement = document.createElement('div');
            subtaskElement.className = 'subtask-editor-item';
            subtaskElement.setAttribute('data-subtask-id', subtaskId);
            subtaskElement.innerHTML = `
                <div class="subtask-editor-content">
                    <input type="checkbox" class="subtask-editor-checkbox" ${completed ? 'checked' : ''}>
                    <input type="text" class="subtask-editor-input" value="${title}">
                    <button class="remove-subtask-btn" onclick="removeSubtask(${subtaskId})" type="button">üóëÔ∏è</button>
                </div>
            `;
            
            subtasksList.appendChild(subtaskElement);
        }

        function removeSubtask(subtaskId) {
            const subtaskElement = document.querySelector(`[data-subtask-id="${subtaskId}"]`);
            if (subtaskElement) {
                subtaskElement.remove();
            }
        }

        function getCurrentSubtasks() {
            const subtaskItems = document.querySelectorAll('.subtask-editor-item');
            return Array.from(subtaskItems).map(item => {
                const id = parseInt(item.getAttribute('data-subtask-id'));
                const checkbox = item.querySelector('.subtask-editor-checkbox');
                const input = item.querySelector('.subtask-editor-input');
                
                return {
                    id: id,
                    title: input.value.trim(),
                    completed: checkbox.checked
                };
            }).filter(subtask => subtask.title);
        }

        function loadTaskSubtasks(subtasks) {
            const subtasksList = document.getElementById('modalSubtasksList');
            subtasksList.innerHTML = '';
            
            subtasks.forEach(subtask => {
                addSubtask(subtask.title, subtask.completed, subtask.id);
                if (subtask.id >= subtaskIdCounter) {
                    subtaskIdCounter = subtask.id + 1;
                }
            });
        }

        // Utilidades de fecha
        function getDueDateInfo(dueDate) {
            if (!dueDate) return null;
            
            const today = new Date().toISOString().split('T')[0];
            const taskDate = new Date(dueDate.split('T')[0]);
            const todayDate = new Date(today);
            
            if (dueDate.split('T')[0] === today) {
                return { text: 'Hoy', class: 'due-today' };
            } else if (taskDate < todayDate) {
                const daysDiff = Math.floor((todayDate - taskDate) / (1000 * 60 * 60 * 24));
                return { text: `Vencido ${daysDiff} d√≠a${daysDiff > 1 ? 's' : ''}`, class: 'due-overdue' };
            } else {
                const daysDiff = Math.floor((taskDate - todayDate) / (1000 * 60 * 60 * 24));
                if (daysDiff === 1) {
                    return { text: 'Ma√±ana', class: 'due-future' };
                } else if (daysDiff <= 7) {
                    return { text: `En ${daysDiff} d√≠as`, class: 'due-future' };
                } else {
                    return { text: new Date(dueDate.split('T')[0]).toLocaleDateString(), class: 'due-future' };
                }
            }
        }

        // Renderizado
        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const filteredTasks = getFilteredTasks();
            
            if (filteredTasks.length === 0) {
                tasksList.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            
            tasksList.innerHTML = filteredTasks.map(task => {
                const project = appData.projects.find(p => p.id === task.projectId);
                const dueDateInfo = getDueDateInfo(task.dueDate);
                
                return `
                    <div class="task-item ${task.completed ? 'completed' : ''}">
                        <div class="task-header">
                            <div class="task-checkbox ${task.completed ? 'completed' : ''}" onclick="toggleTask(${task.id})">
                                ${task.completed ? '‚úì' : ''}
                            </div>
                            <div class="task-content">
                                <div class="task-title ${task.completed ? 'completed' : ''}">${task.title}</div>
                                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                                <div class="task-meta">
                                    ${project ? `<div class="task-project">
                                        <div class="project-color" style="background-color: ${project.color}; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px;"></div>
                                        ${project.name}
                                    </div>` : ''}
                                    ${task.dueDate ? `<div class="task-due-date ${dueDateInfo.class}">
                                        üìÖ ${dueDateInfo.text}
                                    </div>` : ''}
                                    ${task.priority !== 'baja' ? `<div class="task-priority priority-${task.priority}">
                                        ${task.priority}
                                    </div>` : ''}
                                    ${task.labels && task.labels.length > 0 ? `<div class="task-labels">
                                        ${task.labels.map(label => `<span class="task-label">#${label}</span>`).join('')}
                                    </div>` : ''}
                                </div>
                                ${task.subtasks && task.subtasks.length > 0 ? `
                                    <div class="subtasks">
                                        ${task.subtasks.map(subtask => `
                                            <div class="subtask-item">
                                                <div class="subtask-checkbox ${subtask.completed ? 'completed' : ''}" onclick="toggleSubtask(${task.id}, ${subtask.id})">
                                                    ${subtask.completed ? '‚úì' : ''}
                                                </div>
                                                <div class="subtask-title ${subtask.completed ? 'completed' : ''}">${subtask.title}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="task-actions-menu">
                                <button class="action-btn" onclick="editTask(${task.id})" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button class="action-btn" onclick="deleteTask(${task.id})" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            
            projectsList.innerHTML = appData.projects.map(project => {
                const taskCount = appData.tasks.filter(t => t.projectId === project.id && !t.completed).length;
                return `
                    <div class="nav-item" data-project="${project.id}" onclick="switchToProject(${project.id})">
                        <div class="project-color" style="background-color: ${project.color}"></div>
                        <div class="nav-item-text">${project.name}</div>
                        <div class="nav-item-count">${taskCount}</div>
                        <div class="project-actions">
                            <button class="project-action-btn" onclick="event.stopPropagation(); editProject(${project.id})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateProjectSelects();
        }

        function renderLabels() {
            const labelsList = document.getElementById('labelsList');
            
            // Obtener todas las etiquetas √∫nicas de las tareas
            const allLabels = new Set();
            appData.tasks.forEach(task => {
                if (task.labels) {
                    task.labels.forEach(label => allLabels.add(label));
                }
            });
            
            if (allLabels.size === 0) {
                labelsList.innerHTML = '<div style="padding: 8px 20px; font-size: 12px; color: #888; font-style: italic;">No hay etiquetas</div>';
                return;
            }
            
            labelsList.innerHTML = Array.from(allLabels).map(label => {
                const taskCount = appData.tasks.filter(t => 
                    !t.completed && t.labels && t.labels.includes(label)
                ).length;
                
                return `
                    <div class="nav-item" data-label="${label}" onclick="switchToLabel('${label}')">
                        <div class="nav-item-icon">üè∑Ô∏è</div>
                        <div class="nav-item-text">#${label}</div>
                        <div class="nav-item-count">${taskCount}</div>
                    </div>
                `;
            }).join('');
        }

        function updateCounts() {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const counts = {
                today: appData.tasks.filter(t => 
                    !t.completed && (
                        (t.dueDate && t.dueDate.split('T')[0] === today) || 
                        (t.dueDate && new Date(t.dueDate.split('T')[0]) < new Date(today))
                    )
                ).length,
                upcoming: appData.tasks.filter(t => 
                    !t.completed && t.dueDate && new Date(t.dueDate.split('T')[0]) >= new Date(tomorrowStr)
                ).length,
                inbox: appData.tasks.filter(t => !t.completed && !t.projectId).length,
                important: appData.tasks.filter(t => !t.completed && t.priority === 'alta').length,
                all: appData.tasks.filter(t => !t.completed).length,
                completed: appData.tasks.filter(t => t.completed).length
            };
            
            Object.keys(counts).forEach(view => {
                const element = document.getElementById(`${view}Count`);
                if (element) {
                    element.textContent = counts[view];
                }
            });
            
            renderProjects();
        }

        // Modales
        function showTaskModal() {
            document.getElementById('taskModal').classList.add('active');
            updateProjectSelects();
            
            if (!appData.editingTask) {
                document.getElementById('modalTaskTitle').value = '';
                document.getElementById('modalTaskDescription').value = '';
                document.getElementById('modalTaskProject').value = '';
                document.getElementById('modalTaskDate').value = '';
                document.getElementById('modalTaskPriority').value = 'baja';
                document.getElementById('selectedLabels').innerHTML = '';
                document.getElementById('modalSubtasksList').innerHTML = '';
                document.getElementById('modalTaskLabels').value = '';
                document.getElementById('newSubtaskInput').value = '';
            }

            // Configurar event listeners para el modal
            setTimeout(() => {
                const subtaskInput = document.getElementById('newSubtaskInput');
                const labelInput = document.getElementById('modalTaskLabels');
                
                if (subtaskInput) {
                    subtaskInput.onkeypress = null;
                    subtaskInput.addEventListener('keypress', handleSubtaskInput);
                }
                
                if (labelInput) {
                    labelInput.onkeypress = null;
                    labelInput.addEventListener('keypress', handleLabelInput);
                }
            }, 100);
        }

        function hideTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            appData.editingTask = null;
            
            document.getElementById('selectedLabels').innerHTML = '';
            document.getElementById('modalSubtasksList').innerHTML = '';
            document.getElementById('modalTaskLabels').value = '';
            document.getElementById('newSubtaskInput').value = '';
        }

        // Chat
        function toggleChat() {
            const chatContainer = document.getElementById('chat-container');
            const minimizeBtn = document.getElementById('chatMinimizeBtn');
            
            if (chatContainer.classList.contains('minimized')) {
                chatContainer.classList.remove('minimized');
                minimizeBtn.textContent = '‚àí';
            } else {
                chatContainer.classList.add('minimized');
                minimizeBtn.textContent = '+';
            }
        }

        function mostrarMensajeChat(mensaje, esUsuario = false) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-message ${esUsuario ? 'user' : 'bot'}`;
            
            if (esUsuario) {
                div.innerHTML = `<strong>T√∫:</strong> ${mensaje}`;
            } else {
                // Usar marked.js para procesar markdown
                const html = marked.parse ? marked.parse(mensaje) : marked(mensaje);
                div.innerHTML = `<strong>AI:</strong> ${html}`;
            }
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function enviarMensaje() {
            const input = document.getElementById('chat-input');
            const mensaje = input.value.trim();
            if (!mensaje) return;
            
            mostrarMensajeChat(mensaje, true);
            input.value = '';
            
            // Mostrar indicador de escritura
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'chat-message bot';
            loadingMsg.innerHTML = '<strong>AI:</strong> <em>Escribiendo...</em>';
            loadingMsg.id = 'loading-message';
            document.getElementById('chat-messages').appendChild(loadingMsg);
            
            try {
                const respuesta = await assistant.consultarConFunciones(mensaje);
                
                // Remover indicador de carga
                const loadingElement = document.getElementById('loading-message');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                mostrarMensajeChat(respuesta);
                renderTasks();
                renderLabels();
                updateCounts();
            } catch (error) {
                // Remover indicador de carga
                const loadingElement = document.getElementById('loading-message');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                mostrarMensajeChat('‚ùå Error al procesar tu mensaje: ' + error.message);
            }
        }

        // Variables para etiquetas y subtareas en el formulario principal
        let selectedTags = [];
        let selectedSubtasks = [];

        function handleTagInput() {
            const input = document.getElementById('task-tags');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const tag = this.value.trim();
                    if (tag && !selectedTags.includes(tag)) {
                        selectedTags.push(tag);
                        this.value = '';
                        renderSelectedTags();
                    }
                }
            });
        }

        function handleSubtaskInputForm() {
            const input = document.getElementById('task-subtasks');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const subtask = this.value.trim();
                    if (subtask) {
                        selectedSubtasks.push({
                            id: subtaskIdCounter++,
                            title: subtask,
                            completed: false
                        });
                        this.value = '';
                        renderSelectedSubtasks();
                    }
                }
            });
        }

        function renderSelectedTags() {
            const container = document.getElementById('selected-tags');
            container.innerHTML = selectedTags.map(tag => `
                <span class="selected-label">
                    #${tag}
                    <button class="remove-label-btn" onclick="removeTag('${tag}')" type="button">√ó</button>
                </span>
            `).join('');
        }

        function renderSelectedSubtasks() {
            const container = document.getElementById('selected-subtasks');
            container.innerHTML = selectedSubtasks.map(subtask => `
                <div class="subtask-editor-item" style="margin-bottom: 4px;">
                    <div class="subtask-editor-content">
                        <input type="checkbox" ${subtask.completed ? 'checked' : ''} onchange="toggleFormSubtask(${subtask.id})">
                        <span style="flex: 1; padding: 4px;">${subtask.title}</span>
                        <button class="remove-subtask-btn" onclick="removeFormSubtask(${subtask.id})" type="button">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function removeTag(tag) {
            selectedTags = selectedTags.filter(t => t !== tag);
            renderSelectedTags();
        }

        function removeFormSubtask(id) {
            selectedSubtasks = selectedSubtasks.filter(s => s.id !== id);
            renderSelectedSubtasks();
        }

        function toggleFormSubtask(id) {
            const subtask = selectedSubtasks.find(s => s.id === id);
            if (subtask) {
                subtask.completed = !subtask.completed;
            }
        }

        // Event listeners para sliders de configuraci√≥n de IA
        function setupAIConfigListeners() {
            const sliders = ['maxTokens', 'temperature', 'historyLimit'];
            sliders.forEach(sliderId => {
                const slider = document.getElementById(sliderId);
                if (slider) {
                    slider.addEventListener('input', function() {
                        updateSliderValues();
                        updateCostEstimate();
                    });
                }
            });

            const modelSelect = document.getElementById('aiModel');
            if (modelSelect) {
                modelSelect.addEventListener('change', function() {
                    updateCostEstimate();
                    updateCostWarning();
                });
            }
        }

        // Event listeners principales
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar configuraci√≥n y datos
            loadFromLocalStorage();
            loadAIConfig();

            // Establecer fecha y hora actual por defecto
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('task-date').value = now.toISOString().slice(0, 16);

            renderProjects();
            renderLabels();
            renderTasks();
            updateCounts();
            handleTagInput();
            handleSubtaskInputForm();
            setupAIConfigListeners();

            // Configurar buscador
            document.getElementById('searchInput').addEventListener('input', searchTasks);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchTasks();
                }
            });

            // Cerrar modales al hacer clic fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });

            // Cerrar sidebar en mobile al hacer clic en el contenido
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    if (!e.target.closest('.sidebar') && !e.target.closest('.mobile-menu-btn')) {
                        document.getElementById('sidebar').classList.remove('open');
                    }
                }
            });

            // Form submit
            document.getElementById('task-form').onsubmit = (e) => {
                e.preventDefault();
                
                const name = document.getElementById('task-name').value.trim();
                const description = document.getElementById('task-description').value.trim();
                const projectId = parseInt(document.getElementById('task-project').value) || null;
                const date = document.getElementById('task-date').value;
                const priority = document.getElementById('task-priority').value;
                
                if (name) {
                    const nuevaTarea = {
                        id: taskIdCounter++,
                        title: name,
                        description: description || '',
                        projectId: projectId,
                        dueDate: date || null,
                        priority,
                        labels: [...selectedTags],
                        subtasks: [...selectedSubtasks],
                        completed: false,
                        createdAt: new Date().toISOString()
                    };
                    
                    appData.tasks.push(nuevaTarea);
                    saveToLocalStorage();
                    renderTasks();
                    renderLabels();
                    updateCounts();
                    
                    // Limpiar formulario
                    document.getElementById('task-name').value = '';
                    document.getElementById('task-description').value = '';
                    document.getElementById('task-project').value = '';
                    document.getElementById('task-tags').value = '';
                    document.getElementById('task-subtasks').value = '';
                    
                    selectedTags = [];
                    selectedSubtasks = [];
                    renderSelectedTags();
                    renderSelectedSubtasks();
                    
                    // Resetear fecha a actual
                    const now = new Date();
                    now.setMinutes(now.getMinutes-now.getTimezoneOffset());
                    document.getElementById('task-date').value = now.toISOString().slice(0, 16);
                    
                    mostrarMensajeChat(`‚úÖ Tarea "${name}" a√±adida correctamente (ID: ${nuevaTarea.id})`);
                }
            };

            // Cargar datos de ejemplo si no hay tareas
            if (appData.tasks.length === 0) {
                const sampleTasks = [
                    {
                        id: taskIdCounter++,
                        title: 'Completar presentaci√≥n para el cliente',
                        description: 'Preparar slides y ensayar presentaci√≥n',
                        completed: false,
                        priority: 'alta',
                        dueDate: new Date().toISOString().slice(0, 16),
                        projectId: 1,
                        labels: ['urgente', 'presentaci√≥n'],
                        subtasks: [],
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: taskIdCounter++,
                        title: 'Comprar ingredientes para la cena',
                        description: '',
                        completed: false,
                        priority: 'baja',
                        dueDate: new Date().toISOString().slice(0, 16),
                        projectId: 2,
                        labels: ['compras'],
                        subtasks: [
                            { id: subtaskIdCounter++, title: 'Tomates', completed: false },
                            { id: subtaskIdCounter++, title: 'Pasta', completed: true },
                            { id: subtaskIdCounter++, title: 'Queso', completed: false }
                        ],
                        createdAt: new Date().toISOString()
                    }
                ];
                
                appData.tasks = sampleTasks;
                saveToLocalStorage();
                renderTasks();
                renderLabels();
                updateCounts();
            }

            // Mensaje de bienvenida
            setTimeout(() => {
                let welcomeMessage = 'üéâ **¬°Bienvenido a tu Gestor de Tareas Mejorado!**\n\n';
                
                if (!aiConfig.apiKey) {
                    welcomeMessage += 'üîë **Configura tu API Key:** Ve a "Configurar IA" en el sidebar para habilitar el asistente.\n\n';
                }
                
                welcomeMessage += 'üí° **Nuevas funciones del asistente:**\n';
                welcomeMessage += '- "Agregar tareas: [t√≠tulo1], [t√≠tulo2], [t√≠tulo3]" (m√∫ltiples tareas)\n';
                welcomeMessage += '- "Eliminar tareas 1, 2, 3" (operaciones en lote)\n';
                welcomeMessage += '- "Marcar como completadas las tareas 4, 5, 6"\n';
                welcomeMessage += '- "Editar tarea ID 7 cambiar t√≠tulo a [nuevo t√≠tulo]"\n';
                welcomeMessage += '- "Mostrar todas mis tareas"\n\n';
                
                welcomeMessage += 'üìÅ **Gesti√≥n de proyectos:**\n';
                welcomeMessage += '- Edita proyectos haciendo clic en el √≠cono ‚úèÔ∏è\n';
                welcomeMessage += '- Elimina proyectos desde el modal de edici√≥n\n\n';
                
                welcomeMessage += 'üíæ **Gesti√≥n de datos:**\n';
                welcomeMessage += '- Exporta/Importa tus datos desde "Importar/Exportar"\n';
                welcomeMessage += '- Haz respaldos regulares de tu informaci√≥n\n\n';
                
                welcomeMessage += `üìä **Modelo actual:** ${aiConfig.model.replace('gpt-', 'GPT-').replace('-turbo', ' Turbo').replace('4.1-nano', '4.1 nano')}\n`;
                welcomeMessage += `üí∞ **Costo estimado por consulta:** ~$${updateCostEstimate()}\n\n`;
                
                welcomeMessage += '‚ö° **Optimizado para costos** - Solo los √∫ltimos mensajes se env√≠an como contexto.\n';
                welcomeMessage += 'üîÑ **Todos los datos se guardan autom√°ticamente** en tu navegador.';
                
                mostrarMensajeChat(welcomeMessage);
            }, 1000);
        });

        // Funci√≥n para actualizar estimaci√≥n de costo y devolverla
        function updateCostEstimate() {
            const model = aiConfig.model;
            const maxTokens = aiConfig.maxTokens;
            const pricing = modelPricing[model];
            
            if (pricing) {
                const estimatedInputTokens = 500;
                const estimatedOutputTokens = maxTokens;
                const cost = (estimatedInputTokens * pricing.input / 1000) + (estimatedOutputTokens * pricing.output / 1000);
                
                const costElement = document.getElementById('costEstimate');
                if (costElement) {
                    costElement.textContent = `~$${cost.toFixed(4)}`;
                }
                
                return cost.toFixed(4);
            }
            return '0.01';
        }
    </script>
</body>
</html>
